# 7장 도커 컴포즈로 분산 애플리케이션 실행하기

* 각 컴포넌트는 자신만의 경량 컨테이너에서 실행되며 도커가 표준 네트워크 프로토콜을 통해 이들 컨테이너를 엮어냅니다.
* 도커 컴포즈를 사용하면 이렇게 여러 컨테이너에 걸쳐 실행되는 애플리케이션을 정의하고 관리할 수 있습니다.

## 7.1 도커 컴포즈 파일의 구조

* 분산 애플리케이션을 기준으로 Dockerfile 스크립트는 애플리케이션의 한 부분을 패키징하는 수단에 지나지 않습니다.
* 도커 컴포즈 파일은 애플리케이션의 원하는 상태, 다시 말해 모든 컴포넌트가 실행 중일 때 어떤 상태여야 하는지를 기술하는 파일입니다.
* docker container run 명령으로 컨테이너를 실행할 때 지정하는 모든 옵션을 한데 모아 놓은 단순한 형식의 파일입니다.
* 도커 컴포즈 파일을 작성하고나면 도커 컴포즈 도구를 사용해 애플리케이션을 실행합니다. 그러면 도커 컴포즈가 컨테이너, 네트워크, 볼륨 등 필요한 모든 도커 객체를 만들도록 도커 API에 명령을 내립니다.
* 도커 컴포즈 파일 형식에는 애플리케이션의 모든 설정 사항값과 최상위 레벨 도커 요소가 정의됩니다.

## 7.2 도커 컴포즈를 사용해 여러 컨테이너로 구성된 애플리케이션 실행하기

* depends_on 항목을 통해 하나의 서비스가 다른 서비스를 위존함을 기술할 수 있습니다. 이는 depends_on에 명시된 서비스가 먼저 실행됩니다.
* 컴포즈 파일을 사용해 여러 개의 컨테이너로 구성된 애플리케이션을 마치 한 덩어리처럼 다룰 수 있습니다.
* API 서비스는 상태가 없으므로 컨테이너를 늘리는 방법으로 스케일 아웃할 수 있습니다.
* 도커 컴포즈는 컨테이너를 관리하는 별도의 명령이지만 내부적으로는 마찬가지고 도커 API를 사용하기에 도커 컴포즈로 실행한 컨테이너라도 똑같이 도커 명령행으로 관리할 수 있습니다.
* 도커 컴포즈는 클라이언트 측에서 동작하는 도구입니다.
* 도커 엔진 자체는 컨테이너를 실행할 뿐, 여러 컨테이너가 하나의 애플리케이션으로 동작하는지 여부는 알지 못합니다.
* 도커 파일을 수정하거나 도커 명령행으로 직접 애플리케이션을 수정하면, 애플리케이션이 컴포즈 파일에 기술된 구조와 불일치하게 만들 수 있습니다.

## 7.3 도커 컨테이너 간의 통신

* 컨테이너는 도커 엔진으로부터 부여받은 자신만의 가상 IP 주소를 가지며 모두 같은 도커 네트워크로 연결돼 이 IP 주소를 통해 서로 통신할 수 있습니다.
* 애플리케이션 생애주기 동안에 컨테이너가 교체되면 IP 주소도 변경됩니다. IP 주소가 변경돼도 문제가 없도록 도커에서 DNS를 이용해 서비스 디스커버리 기능을 제공합니다.
* DNS는 IP 주소를 도메인과 연결하는 기능을 제공하는 시스템으로, 인터넷과 사설 네트워크에서 모두 동작합니다.
* 도커에도 DNS 서비스가 내장되어 있습니다. 컨테이너에서 실행 중인 애플리케이션도 다른 구성 요소에 접근하기 위해 이 DNS 서비스를 사용합니다.
* 컨테이너 이름을 도메인 삼아 조회하면 해당 컨테이너의 IP 주소를 찾아줍니다.
* 도커 네트워크에 연결된 모든 컨테이너는 이 네트워크 범위에 포함되는 IP 주소를 부여받습니다. 그리고 이 네트워크를 통해 컨테이너 간 통신이 가능합니다.
* 하나의 도메인에 대해 DNS 조회 결과에 여러 개의 IP 주소가 나올 수 있습니다. 도커 컴포즈는 이 점을 활용해 간단한 로드 밸런싱을 구현할 수 있습니다.

## 7.4 도커 컴포즈로 애플리케이션 설정값 지정하기

* 애플리케이션 설정값을 컴포즈 파일에 지정하면, 같은 도커 이미지라도 다양하게 활용할 수 있고 서로 다른 각 환경에 대한 설정을 명시적으로 정의할 수 있습니다.
* 개발 환경과 테스트 환경의 컴포즈 파일을 별도로 작성해두면 공개하는 포트를 환경에 따라 달리하거나 애플리케이션의 기능을 선택적으로 활성화할 수 있습니다.

## 7.5 도커 컴포즈도 만능은 아니다

* 도커 컴포즈는 복잡한 분산 애플리케이션의 설정을 짧고 명료한 포맷의 파일로 나타낼 수 있게 해줍니다.
* docker-compose up 명령을 실행하기만 하면 내가 정의한 상태대로 애플리케이션을 실행할 수 있습니다. 하지만 도커 컴포즈가 할 수 있는 일은 여기까지입니다.
* 도커 컴포즈는 도커 스웜이나 쿠버네티스 같은 완전한 컨테이너 플랫폼은 아닙니다.
* 도커 컴포즈는 이들과 달리 애플리케이션이 지속적으로 정의된 상태를 유지하도록 하는 기능이 없습니다.
* 애플리케이션의 모든 구성 요소가 각자의 Dockerfile 스크립트와 컴포즈 파일을 갖게 되고, 항상 동일한 도구로 애플리케이션을 배포하고 관리할 수 있습니다.


### docker restart

* --restart
    * no: container를 재시작 시키지 않는다. (default)
    * on-failure[:max-retries]: container가 정상적으로 종료되지 않은 경우(exit code가 0이 아님)에만 재시작 시킨다. max-retries도 함께 주면 재시작 최대 시도횟수를 지정할 수 있고, 테스트 서버 등과 같은 리모트에 설정하면 좋을 것 같다.
    * always: container를 항상 재시작시킨다. exit code 상관 없이 항상 재시작 된다.
    * unless-stopped: container를 stop시키기 전 까지 항상 재시작 시킨다.