# 8장 헬스 체크와 디펜던시 체크로 애플리케이션의 신뢰성 확보하기

* 도커 스웜이나 쿠버네티스 같은 컨테이너 플랫폼은 애플리케이션이 스스로 이상에서 회복할 수 있도록 해 주는 기능을 제공합니다.
* 컨테이너 플랫폼은 컨테이너에서 실행 중인 애플리케이션 상태가 정상인지 확인할 수 있는 정보를 이미지에 함께 패키징할 수 있습니다.
* 앞선 방법을 통해 플랫폼이 비정상 컨테이너를 삭제하고 새 컨테이너로 대체할 수 있습니다.

## 8.1 헬스 체크를 지원하는 도커 이미지 빌드하기

* 도커는 애플리케이션의 상태가 실제로 정상인지 확인할 수 있는 정보를 도커 이미지에 직접 넣을 수 있는 기능을 제공합니다.(HEALTHCHECK)
* 컨테이너의 이상 상태는 도커 API를 통해 보고됩니다. 따라서 컨테이너를 실행 중인 플랫폼도 컨테이너의 이상 상태를 통보받고 애플리케이션을 복구하기 위한 조치를 취할 수 있습니다.
* 도커는 컨테이너 안 애플리케이션이 이상 상태임에도 재실행하거나 다른 컨테이너로 교채하지 않는 이유는 이런 작업을 안전하게 처리할 수 없기 때문입니다.
* 도커가 동작하는 여러 대의 서버로 구성되고 도커 스웜이나 쿠버네티스가 관리하는 클러스터 환경에서는 자동적으로 조치를 취할 수 있기에 헬스 체크 기능이 더욱 유용합니다.

## 8.2 디펜던시 체크가 적용된 컨테이너 실행하기

* 여러 컨테이너에 나뉘어 실행되는 분산 애플리케이션은 이상이 생긴 컨테이너를 교체할 때는 처음 애플리케이션을 실행할 때처럼 컨테이너 간 의존관계를 고려하지 않기에 다른 문제가 생길 수 있습니다.
* 클러스터 환경의 컨테이너 플랫폼이라면 컨테이너의 실행 순서까지 통제할 수 없습니다. 그래서 API가 사용 가능한 상태가 되기 전에 웹 애플리케이션이 실행되는 일이 있을 수 있습니다.
* 의존 관계를 만족하는지 점검하는 디펜던시 체크 기능도 도커 이미지에 추가할 수 있습니다.

## 8.3 애플리케이션 체크를 위한 커스텀 유틸리티 만들기

* curl은 API를 테스트하는데 유용하지만 보안 정책상의 이유로 이미지에 curl을 포함시킬 수 없을 수 있습니다.
* curl이 컨테이너 상태 체크에 유용한 도구이기는 하지만 실제 애플리케이션 체크에는 애플리케이션과 같은 언어로 구현된 별도의 커스텀 유틸리티를 사용하는 것이 좋습니다.
* 애플리케이션과 같은 언어로 구현된 커스텀 유틸리티의 장점은 다음과 같습니다.
  * 커스텀 유틸리티를 실행할 때도 애플리케이션과 같은 도구를 사용하므로 이미지에 추가적인 소프트웨어를 포함시킬 필요가 없습니다.
  * 재시도 횟수나 분기 등 셸 스크립트로는 표현하기 까다로운 복잡한 체크 로직을 적용할 수 있습니다.
  * 애플리케이션과 같은 설정을 사용해 대상 URL을 여러 곳에 반복 정의하거나 수정에서 누락시키는 일을 방지할 수 있습니다.
  * 애플리케이션과 같은 라이브러리 환경에서 데이터베이스 접속이나 인증서 파일의 존재 유무 등 컨테이너 실행 전에 확인이 필요한 모든 사항을 검증할 수 있습니다.

## 8.4 도커 컴포즈에 헬스 체크와 디펜던시 체크 정의하기

* 도커 컴포즈는 애플리케이션의 상태에 이상이 생겼을 때 어느 정도 복원할 수 있는 기능이 있습니다. 하지만 도커 컴포즈도 이상이 생긴 컨테이너를 새 컨테이너로 대체하지는 않습니다.
* 도커 컴포즈 파일에는 헬스 체크의 옵션을 더 세세하게 설정할 수 있습니다.
  * interval : 헬스 체크 실시 간격을 의미합니다.
  * timeout : 지정된 시간만큼 응답을 받지 못하면 실패로 간주하는 제한 시간을 의미합니다.
  * retries : 컨테이너 상태를 이상으로 간주할 때까지 필요한 연속 실패 횟수를 의미합니다.
  * start_period : 컨테이너 실행 후 첫 헬스 체크를 실시하는 시간 간격을 의미합니다. 애플리케이션을 시작하는 데 시간이 오래 걸리는 경우 필요합니다.
* 이미지에 헬스 체크가 정의되지 않았다면 healthcheck의 test를 통해 정의할 수 있습니다.
* 도커 컴포즈는 디펜던시를 체크할 수 있는 범위가 단일 서버로 제한됩니다.

## 8.5 헬스 체크와 디펜던시 체크로 복원력 있는 애플리케이션을 만들 수 있는 이유

* 여러 개의 요소로 구성된 분산 시스템으로 동작하는 애플리케이션은 유연성과 기민성 면에서 뛰어납니다. 하지만 그만큼 관리가 어려워집니다.
* 디펜던시 체크와 헬스 체크를 도입하면 처음부터 플랫폼이 실행 순서를 보장하게 할 필요가 없습니다.
* 애플리케이션의 자기 수복이란 일시적인 오류를 플랫폼이 해소해 주는 것입니다.
* 헬스 체크는 주기적으로 자주 실행되므로, 시스템에 부하를 주는 내용이여서는 안됩니다.
* 디펜던시 체크는 애플리케이션 시작 시에만 실행되므로 테스트에 소모되는 리소스에 너무 크게 신경 쓸 필요는 없습니다. 하지만 테스트 대상이 빠짐없이 정확하도록 주의해야 합니다.

## 연습 문제

~~~
FROM diamol/node

ENV MAX_ALLOCATION_MB=4096 \
    LOOP_ALLOCATION_MB=512 \
    LOOP_INTERVAL_MS=2000

CMD  node memory-hog.js && node memory-check.js

HEALTHCHECK --interval=5s CMD node memory-check.js

WORKDIR /app
COPY src/ .
~~~