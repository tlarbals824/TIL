# 10장 도커 컴포즈를 이용한 여러 환경 구성

* 이식성은 도커의 가장 핵심적인 장점입니다.
* 컨테이너로 실행하기 위해 패키징된 애플리케이션은 어떤 환경에 애플리케이션을 배포해도 동일하게 동작합니다.
* 환경 변화는 수동에 의존하는 소프트웨어 배포에서 불가피하게 발생합니다.
* 도커는 패키지에 모든 의존 모듈이 함께 들어가기에 이러한 문제를 해결할 수 있습니다. 하지만 환경에 따라 애플리케이션의 동작을 달리해야 할 필요는 여전히 남습니다.

## 10.1 도커 컴포즈로 여러 개의 애플리케이션 배포하기

* 도커 컴포즈는 여러 개의 컨테이너로 구성된 애플리케이션을 단일 도커 엔진 호스트에서 실행하기 위한 도구입니다.
* 여러 환경을 구성해 용도별로 사용하려면, 환경마다 애플리케이션이 다르게 동작하게끔 해야 합니다.
* 도커 컴포즈가 어떤 리소스가 애플리케이션의 일부인지 아닌지 판단하는 원리를 먼저 고려해야 하는데, 그 기준은 레이블의 명명 규칙을 따릅니다.
* 도커 컴포즈는 도커 리소스가 어떤 애플리케이션의 일부인지 아닌지를 판정하기 위해 프로젝트라는 개념을 사용합니다.
* 프로젝트 이름의 기본값은 도커 컴포즈 파일이 들어 있던 디렉터리명이며, 도커 컴포즈가 도커 리소스를 만들 떄 이 프로젝트 이름을 리소스의 이름에 접두사로 붙이고, 컨테이너 이름에는 번호를 접미사로 붙입니다.
* 프로젝트 이름을 통해 같은 애플리케이션도 여러 번 실행할 수 있습니다.
* 하지만 이러한 방법은 무작위로 정해진 공개 포트를 일일이 찾아야한다는 점입니다.

## 10.2 도커 컴포즈의 오버라이드 파일

* 하나의 애플리케이션을 여러 설정으로 실행해야 할 필요가 생긴 경우 대부분은 컴포즈 파일을 여러 개 두는 방법을 사용합니다.
* 컴포즈 파일을 여러개 구성하는 방법은 유지 보수 측면에서 바람직하지 않습니다.
* 이러한 문제를 오버라이드 파일을 통해 해결할 수 있습니다.
* 오버라이드 파일에는 해당 환경에서 변경할 항목만 기술하면 됩니다. 하지만 기본 컴포즈 파일의 구조를 유지해야 도커 컴포즈가 두 정의를 연결지을 수 있습니다.
* 도커 컴포즈는 하나 이상의 파일이 인자로 지정됐을 때 이들 파일을 병합합니다.
* 도커 컴포즈가 오버라이드 파일을 병합하는 순서는 인자로 받은 순서를 따릅니다. 즉, 인자로 지정된 순서가 먼저인 파일이 순서가 나중인 파일보다 우선합니다.

## 10.3 환경 변수와 비밀값을 이용해 설정 주입하기

* 비밀값은 도커 컴포즈, 도커 스웜, 쿠버네티스에서 모두 지원하는 기능으로, 설정값을 주입하기에 매우 유용한 기능입니다.
* 다음 프로퍼티는 애플리케이션에 설정 값을 주입해 동작을 변화시키는 역할을 합니다.
  * environment : 컨테이너 안에서만 사용되느느 환경 변수를 추가합니다.
  * env_file : 텍스트 파일의 경로를 값으로 받습니다.
  * secret : services, networks처럼 컴포즈 파일의 최상위 프로퍼티이며, 이 프로퍼티의 실제 값 혹은 경로가 정의됩니다.
* 달려 기호($)를 통해 환경 변수 값으로 치환이 가능합니다.
* .env 파일에 포함된 정보는 크게 두 가지로 나눌 수 있습니다.
  * 웹 애플리케이션의 공개 포트 같은 컨테이너 설정
  * 프로젝트 이름이나 컴포즈 파일 이름 같은 컴포즈 명령 자체에 대한 옵션
* 컴포즈 파일과 함께 환경 파일을 잘 관리하면 어떤 파일이 어떤 환경의 설정값에 해당하는지에 대한 문서 역할을 대신할 수 있습니다.
* 도커 컴포즈는 .env 파일만을 환경 파일로 간주하기에 환경 파일 여러 개를 만들어 바꿔가며 사용할 수 없습니다.

## 10.4 확장 필드로 중복 제거하기

* 도커 컴포즈 설정 기능은 비교적 단순한 기능이기에 한계점이 존재합니다.
  * 서비스 간 많은 설정값을 공유하는 컴포즈 파일의 덩치가 커지는 문제
* 이러한 문제는 컴포즈의 기능인 확장 필드를 통해 해결할 수 있습니다.
* 확장 필드는 스크립트의 중복을 제거하는 동시에 잠재적인 오류를 줄여 줍니다. 또한 yml 병합 문법에 익숙하다면 직관적으로 사용할 수 있습니다.
* 확장 필드는 일종의 사용자 정의 필드입니다.
* 확장 필드는 컴포즈 파일을 관리하는 베스트 프랙티스 중 한 가지 방법입니다. 하지만 확장 필드에도 여러 컴포즈 파일에 한꺼번에 적용할 수 없다는 한계점이 있습니다.

## 10.5 도커를 이용한 설정 워크플로 이해하기

* 도커 컴포즈를 이용하면 환경 간의 설정 차이를 소스 코드 형상 관리를 통해 다룰 수 있습니다.
* 도커 컴포즈를 이용해 서로 다른 환경을 정의하는 방법은 다음과 같은 세 가지 핵심 영역이 있습니다.
  * 애플리케이션 구성 요소의 조합 
  * 컨테이너 설정
  * 애플리케이션 설정