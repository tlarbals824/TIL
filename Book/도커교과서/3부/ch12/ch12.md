# 12장 컨테이너 오케스트레이션: 도커 스웜과 쿠버네티스

* 도커 스웜이나 쿠버네티스 같은 오케스트레이션 도구를 통해 도커 호스트와 컨테이너를 관리할 수 있습니다.

## 12.1 컨테이너 오케스트레이션 도구란?

* 서비스 운영에 있어 시스템은 고가용성을 요구하는데, 이를 위해 오케스트레이션이 필요해집니다.
* 오케스트레이션 도구란 기본적으로 클러스터를 구성하는 여러대의 호스트 컴퓨터를 의미합니다.
* 오케스트레이션 도구는 컨테이너를 관리하고, 서비스를 제공하기 위한 작업을 여러 컴퓨터에 분배하며, 네트워크 트래픽 부하를 고르게 분산시키고, 상태가 불량한 컨테이너를 새 컨테이너로 교체하는 일을 담당합니다.
* 클러스터에 애플리케이션을 배포하려면 클러스터에 YAML 파일을 전달하면 그에 맞춰 동원 가능한 서버에서 컨테이너를 생성해 애플리케이션을 실행, 유지, 관리 해줍니다.
* 복잡한 컨테이너 관리는 모두 오케스트레이션 도구가 대신해 줍니다.

## 12.2 도커 스웜으로 클러스터 만들기

* 도커 스웜은 도커 엔진에 포함돼 있어 별도의 설치가 필요 없으며 도커 엔진을 스웜 모드로 전환해 클러스터를 초기화하면 됩니다.
* 클러스터에 속한 컴퓨터는 매니저와 워커라는 두 가지 역할 중 하나를 맡습니다.
* 매니저는 클러스터를 관리하는 작업을 직접 수행합니다.
* 워커는 매니저의 스케줄링에 따라 컨테이너를 실행하고 그 상태를 주기적으로 매니저에 보고하는 역할을 합니다. 매니저 또한 이러한 역할을 할 수 있습니다.
* 스웜에 노드를 추가하기 위해서는 해당 컴퓨터가 스웜과 같은 네트워크상에 위치해야합니다.
* 도커 스웜이 쿠버네티스보다 나은 점 중 하나는 클러스터를 구성하고 관리하는 작업이 단순하다는 점입니다.

## 12.3 도커 스웜 서비스로 애플리케이션 실행하기

* 도커 스웜 환경에서는 컨테이너를 직접 실행할 필요가 없습니다. 서비스를 배포하면 스웜이 대신 컨테이너를 실행해줍니다.
* 서비스는 컨테이너를 추상화한 개념입니다.
* 서비스는 컨테이너와 같은 정보로 정의됩니다. 사용되는 이미지, 환경 변수와 값, 공개되는 포트와 같은 정보입니다.
* 서비스는 도커 스웜의 일급 객체이지만, 서비스를 다루려면 도커 엔진이 스웜 모드이거나 스웜 매니저에 연결된 상태여야 합니다.
* 서비스를 구성하는 컨테이너를 레플리카라고 부릅니다.
* 도커 엔진을 스웜 모드로 전환했다면, 애플리케이션을 서비스로 보고 각각의 컨테이너를 관리하는 것은 스웜에 맡겨야 합니다.
* 서비스 전체의 구성 정보는 클러스터에 저장돼 있으므로, 포맷 파라미터 없이 service inspect 명령을 입력하면 확인할 수 있습니다.
* 클러스터 데이터베이스에는 상당히 많은 정보가 들어 있는데, 이들 정보는 안전하게 암호화돼 모든 매니저 노드마다 복제본을 위치합니다.
* 도커 컴포즈가 도커 스웜가 가장 큰 다른 점은 애플리케이션 정의를 저장할 공간을 갖지 않는다는 점입니다.
* 모든 컨테이너 오케스트레이션 도구는 애플리케이션을 업데이터할 때 애플리케이션을 중단시키지 않고 점진적으로 컨테이너를 교채하는 롤링 업데이트 방식을 사용합니다.
* 자동화된 롤링방식은 자기 수복형 애플리케이션의 또 다른 기능적 축을 담당합니다.
* 새로 투입된 신 버전 컨테이너에서 문제가 발생하면 업데이트가 자동으로 중단돼 전체 애플리케이션으로 문제가 번지지 않도록 막습니다.
* 스웜의 데이터베이스는 이전 버전의 서비스 정의 내용이 남아 있으므로 명령 한 번으로 이전 버전으로 롤백할 수 있습니다.

## 12.4 클러스터 환경에서 네트워크 트래픽 관리하기

* 컨테이너에서 실행되는 애플리케이션 입장에서 스웜 모드의 네트워크는 표준 TCP/IP 방식입니다.
* 컴포넌트는 도메인 네임으로 서로를 식별하며, 도커 DNS 서버가 도메인 네임을 조회해 IP주소를 알려주면 이 IP 주소로 트래픽을 전달합니다.
* 스웜 모드에서는 서로 다른 노드에서 실행중인 컨테이너 간에 요청과 응답을 주고 받을 수 있지만, 컨테이너와 컨테이너에서 실행 중인 애플리케이션을 이를 신경 쓸 필요가 없습니다.
* 스웜 모드에서는 오버레이 네트워크라는 새로운 형태의 도커 네트워크를 사용할 수 있습니다.
* 오버레이 네트워크는 클러스터에 속한 모든 노드를 연결하는 가상 네트워크입니다.
* 오버레이 네트워크에 연결된 서비스는 서비스 이름을 도메인 네임 삼아 다른 서비스와 통신할 수 있습니다.
* 오버레이 네트워크와 일반적인 네트워크의 차이점은 오버레이 네트워크에서는 서비스를 가리키는 가상 IP 주소를 반환한다는 점입니다.
* 가상 IP는 해당 서비스에 속한 모든 레플리카가 공유하는 주소입니다.
* 도커 스웜은 서비스 접근에 대한 신뢰성을 높이고 부하를 잘 분산시키기 위해 VIP 네트워크를 사용합니다.
* 스웜 모드는 클러스터로 들어오는 트래픽을 처리하는 복잡한 과정을 드러내지 않고 숨겨 둡니다.
* 스웜은 인그레스 네트워킹을 통해 모든 노드가 같은 포트를 감시하며 외부 트래픽을 받고, 특정 노드에 도달한 트래픽에 대한 내부적인 로드 밸런싱을 도커가 맡습니다.
* 서비스의 포트를 공해마녀 인그레스 네트워크가 기본적으로 적용됩니다.

## 12.5 도커 스웜과 쿠버네티스 중 무엇을 사용할까?

* 도커 스웜은 상대적으로 간단한 컨테이너 오케스트레이션 도구로 설계됐습니다.
* 쿠버네티스는 주요 클라우드 서비스에서 매니지드 서비스 형태로 제공되기에 유명합니다.
* 도커 스웜은 쿠버네티스에 비해 확장성이 떨어집니다.
* 클러스터 생성은 애플리케이션 배포보다는 빈도가 적습니다. 하지만 반복적으로 해야 하는 업무일 때는 도커 스웜을 사용하는 편이 훨씬 간편합니다.