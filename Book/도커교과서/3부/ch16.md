# 16장 어디서든 실행할 수 있는 도커 이미지 만들기 : 리눅스, 윈도, 인텔, ARM

* 다중 아키텍처 이미지는 여러 개의 변종 이미지 형태로 빌드되고 레지스트리에 푸시됩니다.
* 각각의 변종 이미지는 서로 다른 아키텍처나 운영체제 환경을 대상으로 합니다.
* 다중 아키텍처 이미지를 내려받으려 시도하면 도커는 자동으로 호스트의 아키텍처에 맞는 이미지를 내려받습니다.

## 16.1 다중 아키텍처 이미지가 중요한 이유

* 도커는 시스템 정보를 이용해 환경에 맞는 이미지를 내려받습니다. 이 과정에서 이미지를 구성하는 레이어를 내려받는 것 외에 이미지를 바로 사용할 수 있도록 레이어의 압축을 푸는 과정도 포함됩니다.
최적화 과정은 호스트 컴퓨터의 아키텍처와 일치해야 합니다.
* 호스트 컴퓨터와 일치하는 이미지가 없다면 오류가 발생합니다.
* 리눅스용 이미지의 경우 아키텍처가 일치하지 않아도 내려받기가 가능합니다. 하지만 실행은 되지 않습니다.
* 이미지 매니페스트 리스트는 이미지 변종 목록을 나타냅니다.

## 16.2 다중 아키텍처 이미지를 만들기 위한 Dockerfile 스크립트

* 멀티 스테이지 Dockerfile 스크립트를 이용해 컨테이너에서 소스 코드를 빌드하고 패키징하는 방법을 통해 다중 아키텍처 이미지를 만들 수 있습니다.
* 멀티 스테이지 Dockerfile 스크립트 방법을 사용하기 위해서는 애플리케이션에 사용된 SDK나 런타임에 원하는 아키텍처를 지원해야 합니다.
* 멀티 스테이지 Dockerfile 스크립트 방법의 큰 장점은 Dockerfile 스크립트 하나로 다른 아키텍처의 컴퓨터에서 이미지를 빌드하면 해당 아키텍처의 이미지를 만들 수 있다는 점입니다.
* 멀티 스테이지 Dockerfile 스크립트 방법에서 모든 아키텍처에서 지원하지 않는다면 Dockerfile 스크립트를 아키텍처나 운영체제별로 따로 작성해야 합니다.
* 도커 엔진은 필요한 경우 에뮬레이션 기능을 사용합니다.
* 운영체제 따라 Dockerfile을 작성하는 경우 Dockerfile CMD에 각 운영체제에 맞는 명령어를 사용해야 합니다.

## 16.3 다중 아키텍처 이미지를 레지스트리에 푸시하기

* 이미지를 다중 아키텍처 이미지로 만들려면 매니페스트와 함께 이미지들을 레지스트리에 푸시해야 합니다.
* 매니페스트란 여러 개의 변종 이미지를 하나의 이미지 태그로 묶는 메타데이터를 말합니다.
* 매니페스트는 도커 명령행 도구로 만들어 레지스트리에 푸시합니다.
* 매니페스트는 이미지 변종의 목록이 담기는데, 이들 이미지가 먼저 레지스트리에 푸시된 상태여야 합니다.

## 16.4 도커 Buildx를 사용해 다중 아키텍처 이미지 빌드하기

* Buildx는 docker build 명령의 확장판이며 최적화된 빌드 엔진이 적용돼 빌드 성능이 뛰어납니다.
* Buildx는 Dockerfile 스크립트를 입력받아 이미지를 생성하는 것은 이전과 동일하기에 docker build 명령을 대체할 수 있습니다.
* Buildx는 크로스 플랫폼 빌드를 지원하며 도커 컨텍스트와 통합돼 있기에 한 번의 명령으로 여러 대의 서버에서 빌드를 진행할 수 있습니다.
* Buildx는 빌더로 사용 가능한 도커 컨텍스트를 찾아 컨텍스트가 가리키는 노드의 플랫폼 정보를 스스로 확인할 수 있을 만큼 유연성이 뛰어납니다.
* Buildx는 이미지 빌드, 푸시, 매니페스트 생성과 푸시까지 모든 작업을 수행해줍니다.
* Buildx를 이용하면 간단하게 다중 아키텍처 이미지를 빌드할 수 있습니다.

## 16.5 개발 로드맵과 다중 아키텍처 이미지

* Dockerfile 스크립트를 이용해 다중 아키텍처 이미지로 전환하는 방법은 다음과 같습니다.  
  1. FROM 인스트럭션에 항상 다중 아키텍처 이미지를 기반 이미지로 지정합니다.
  2. RUN,CMD 인스트럭션에는 특정 운영체제에서만 사용되는 명령어를 사용하지 않는 것입니다.