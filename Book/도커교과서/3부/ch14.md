# 14장 업그레이드와 롤백을 이용한 업데이트 자동화

* 컨테이너에서 실행되는 애플리케이션을 오케스트레이션 도구와 조합하면 무중단 업데이트가 가능합니다.

## 14.1 도커를 사용한 애플리케이션 업그레이드 프로세스

* 배포 주기는 애플리케이션 버전을 제외하고도 최소한 네 가지 주기를 생각해야 합니다.
  1. 의존성 모듈 업데이트
  2. 애플리케이션 코드를 컴파일하는 데 사용하는 SDK 업데이트
  3. 애플리케이션이 동작하는 플랫폼의 업데이트
  4. 운영체제 업데이트
* global 모드로 동작하는 서비스는 한 노드에 레플리카를 하나만 실행합니다. 이는 인그레스 네트워크를 우회하기 위한 목적으로 사용하는데, 리버스 프록시 같은 상황에서 유용하게 사용할 수 있는 모드입니다.
* host 모드로 동작하는 서비스는 인그레스 네트워크 대신 호스트의 명시된 포트 번호로 연결합니다. 이를통해 네트워크 내 라우팅에 따른 오버헤드를 제거할 수 있습니다.
* 서비스 업데이트는 항상 기존 컨테이너를 먼저 종료하고 새 컨테이너를 실행하는 식의 롤링 업데이트로 이뤄집니다.
* 레플리카는 하나씩 쿄체되며 새 컨테이너가 정상적으로 실행되는지 확인이 끝난 후 다음 컨테이너 업데이트에 들어갑니다.

## 14.2 운영 환경을 위한 롤링 업데이트 설정하기

* 롤링 업데이트의 세세한 방식은 컴포즈 파일 내 서비스 정의 deploy 항목에서 설정할 수 있습니다.
    * parallelism : 한 번에 교체하는 레플리카 수
    * monitor : 다음 컨테이너 교체로 넘어가기 전에 새로 실행한 컨테이너의 이상 여부를 모니터링하는 시간
    * failure_action : monitor에 설정한 시간 이내에 헬스 체크가 실패하거나 컨테이너가 실행되지 않아 롤링 업데이트가 실패한 경우에 취해야하는 조치
    * order : 레플리카를 교체하는 절차의 순서
* 업데이트 설정을 변경할 때는 배포에도 설정을 포함시켜야 합니다.
* 롤링 업데이트에 대한 설정과 똑같은 설정을 롤백에도 할 수 있습니다.

## 14.3 서비스 롤백 설정하기

* docker stack rollback 명령은 따로 존재하지 않습니다. 
* 애플리케이션을 이전 상태로 되돌리는 것은 서비스 단위로 이뤄집니다.
* 대개 롤백은 자동화된 롤링 업데이트 과정에서 새로 투입한 레플리카가 모니터링 중 오류를 일으켰을 때 수행됩니다.
* 애플리케이션 배포는 서비스 중단 시간의 주요 원인입니다.
* 롤백 설정의 기본값은 업데이트와 마찬가지로 한 번에 한 태스크씩 stop-first 방식으로 교체하고, 모니터링 시간은 0 이며, 교체된 레플리카가 헬스 체크에 실패할 경우 업데이트를 중단하는 것입니다.
* 롤백이 끝나고 나면 롤백 설정또한 이전으로 돌아갑니다.

## 14.4 클러스터의 중단 시간

* 컨테이너 오케스트레이션 도구는 여러 대의 컴퓨터를 묶어 하나의 강력한 클러스터로 만듭니다. 하지만 컨테이너를 실행하는 각각의 컴퓨터에서 중단 시간이 발생할 수 있습니다.
* 스웜에서 유지 보수 모드를 드레인 모드라고 합니다. 매니저 노드와 워커 노드 모두 드레인 모드로 설정할 수 있습니다.
* 워커 노드와 매니저 노드의 드레인 모드 모두 실행 중인 레플리카가 종료되고 새로운 레플리카를 실행하지도 않는다는 점이 같습니다.
* 차이점으로는 매니저 노드는 드레인 모드가 돼도 계속 클러스터의 관리 그룹으로 가능하며 클러스터 데이터베이스 동기화 및 관리 API 제공도 계속하고 매니저 노드 중 리더인 리더 매니저가 될 수 있습니다.
* 고가용성을 위해서는 매니저 노드가 둘 이상 필요합니다. 하지만 능동-수동 고가용성 모델을 따르기 때문에 클러스터를 실제로 통제하는 매니저는 하나뿐입니다. 이는 리더 매니저입니다.
* 매니저 노드에서 node rm 명령이나 swarm leave 명령을 통해 노드를 제거할 수 있습니다.

## 14.5 스웜 클러스터의 고가용성

* 헬스 체크는 애플리케이션 동작 상태를 확인해 이상 상태에 빠진 컨테이너를 새 컨테이너로 교체하고, 여러 개의 워커 노드는 노드 중 하나가 고장을 일으켜도 다른 컨테이너를 실행할 능력을 보존하며, 
여러 개의 매니저 노드는 워커 노드 모니터링 및 컨테이너 배치 능력의 여유분을 확보하는 역할을 했습니다.
* 지역을 아우르는 거대한 규모의 장애에도 애플리케이션이 계속 동작해야 할 필요가 있다면, 클러스터를 여러 개 구성하는 방법뿐입니다.