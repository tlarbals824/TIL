# 3장 도커 이미지 만들기

| 플래그    | 설명                   |
|--------|----------------------|
| --name | 컨테이너 이름을 부여할 수 있습니다. |
| --env  | 환경 변수 설정할 수 있습니다.    |


## 3.1 도커 허브에 공유된 이미지 사용하기

* 도커 이미지는 논리적으로는 하나의 대상입니다.
* 이미지를 내려받는 과정을 통해 여러 건의 파일을 동시에 내려받는다는 점에서 단일 파일을 내려받는 과정이 아니라는 것을 알 수 있습니다. 이들 각각을 이미지 레이어라고 부릅니다.
* 도커 이미지는 물리적으로는 여러 개의 작은 파일로 구성돼 있습니다. 그리고 도커가 이 파일들을 조립해 컨테이너의 내부 파일 시스템을 만듭니다.
* 모든 레이어를 내려받고 나면 전체 이미지를 사용할 수 있게됩니다.
* 환경 변수는 운영체제에서 제공하는 키-값 쌍입니다. 윈도우나 리눅스나 같은 방식으로 동작하며, 아주 적은 양의 데이터를 저장하는 데 유용합니다.
* 도커 컨테이너도 별도의 환경변수를 가질 수 있습니다. 하지만 이는 호스트 운영체제의 것이 아닌 컨테이너의 호스트명이나 IP 주소처럼 도커가 부여합니다.
* 환경 변수를 통해 도커 이미지의 설정값의 기본값을 바꿀 수 있습니다.

## 3.2 Dockerfile 작성하기

* Dockerfile은 애플리케이션을 패키징하기 위한 간단한 스크립트입니다.
* Dockerfile은 인련의 인스트럭션으로 구성돼 있는데, 인스트럭션을 실행한 결과로 도커 이미지가 만들어집니다.

| 인스트럭션 | 설명 |
|-|-|
|FROM|이미지의 기반이 될 베이스 이미지를 지정합니다.|
|ENV|환경 변수를 설정합니다.|
|WORKDIR|명시한 디렉터리를 작업 디렉터리로 지정하는 인스트럭션입니다.|
|COPY|호스트 파일 시스템에 있는 파일을 이미지로 복사합니다.|
|CMD|도커가 이미지로부터 컨테이너를 실행했을 때 실행할 명령을 지정하는 인스트럭션입니다.|

## 3.3 컨테이너 이미지 빌드하기

* 이미지를 빌드하려면 Dockerfile 스크립트 외에도 이미지의 이름, 패키징에 필요한 파일의 경로를 추가적으로 지정해 주어야 합니다.
* 이미지 빌드시 명령어 마지막에 .은 '현재 작업 디렉터리'라는 뜻입니다.

## 3.4 도커 이미지와 이미지 레이어 이해하기

* 도커 이미지에는 우리가 패키징에 포함시킨 모든 파일이 들어 있습니다. 이 파일들은 나중에 컨테이너의 파일 시스템을 형성합니다.
* 이 외에도 이미지에는 자신에 대한 여러 메타데이터 정보도 들어 있습니다. 이 정보ㅈ 중 이미지가 어떻게 빌드됐는지에 대한 간단한 이력도 포함됩니다.
* 이 정보를 이용하면 이미지를 구성하는 각 레이어는 무엇이고 이들 레이어가 어떤 명령으로 빌드됐는지 알 수 있습니다.
* Dockerfile 인스트럭션과 이미지 레이어는 1:1관계를 갖습니다.
* 도커 이미지는 이미지 레이어가 모인 논리적 대상입니다. 레이어는 도커 엔진의 캐시에 물리적으로 저장된 파일입니다.
* 이미지 레이어는 여러 이미지와 컨테이너에서 공유됩니다.
* 도커는 이미지를 빌드하면서 레이어가 만들어지면 레이어는 다른 이미지에서 재사용될 수 있지만 수정할 수 없습니다.

## 3.5 이미지 레이어 캐시를 이용한 Dockerfile 스크립트 최적화

* 도커 이미지 레이어 중 중간에 있는 레이어가 변경되면 변경된 레이어보다 위에 오는 레이어를 재사용할 수 없습니다.
* Dockerfile 스크립트의 인스트럭션은 각각 하나의 이미지 레이어와 1:1로 연결되지만 인스트럭션의 결과가 이전 빌드와 같다면, 이전에 캐시된 레이어를 재사용합니다.
* 도커는 캐시에 일치하는 레이어가 있는지 확인하기 위해 해시값을 사용합니다.
* 해시값은 Dockerfile 스크립트의 인스트럭션과 인스트럭션에 의해 복사되는 파일의 내용으로부터 계산되는데, 기존 이미지 레이어에 해시값이 일치하는 것이 없다면 캐시 미스가 발생하고 해당 인스트럭션이 실행됩니다.


## 3.6 연습 문제

~~~
docker container run -it --name lab diamol/ch03-lab
    /diamol # ls
    ch03.txt
    /diamol # vi ch03.txt
    /diamol # exit
docker container commit lab lab_change
~~~