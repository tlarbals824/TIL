# 6장 도커 볼륨을 이용한 퍼시스턴트 스토리지

* 컨테이너는 무상태 애플리케이션에게는 최적의 실행 환경입니다.
* 사용량이 증가하더라도 클러스터에 실행 중인 컨테이너의 수를 늘리기만 하면, 모든 요청이 똑같이 신뢰성 있게 처리됩니다. 또 롤링 업데이트를 통해 서비스 중단 없이 점진적으로 업데이트를 배포할 수 있습니다.

## 6.1 컨테이너 속 데이터가 사라지는 이유

* 도커 컨테이너에도 단일 드라이브 그리고 독립된 파일 시스템이 있습니다.
* 컨테이너의 파일 시스템은 단일 디스크입니다.
* 이 단일 디스크는 도커가 여러 출처로부터 합쳐 만들고 컨테이너에 전달한 가상 파일 시스템입니다.
* 이 출처는 이미지 레이어와 컨테이너의 기록 가능 레이어로 구성되는데, 이미지 레이어는 모든 컨테이너가 공유하지만 기록 가능 레이어는 컨테이너마다 다릅니다.
* 이미지 레이어는 이미지를 내려받는 순간부터 삭제할 때까지 로컬 컴퓨터의 이미지 레이어에 존재합니다.
* 컨테이너의 쓰기 가능 레이어는 컨테이너를 실행할 때 생성되며 컨테이너를 삭제할 때 함께 삭제됩니다.
* 기록 가능 레이어를 새 파일을 만드는 데만 사용하는 것이 아닙니다. 기존 이미지 레이어에 있는 파일을 수정할 수 있습니다.
* 이미지 레이어는 읽기 전용이지만 기록 중 복사라는 방법을 사용해 읽기 전용 레이어의 파일을 수정할 수 있습니다.
* 기록 중 복사는 이미지 레이어의 파일을 쓰기 가능 레이어로 복사해 온 다음 쓰기 가능 레이어에서 파일을 수정합니다.
* 컨테이너 속 파일을 수정하면 컨테이너의 동작에 영향을 미칩니다. 그러나 이미지를 공유하는 다른 컨테이너나 이미지는 영향을 받지 않습니다.
* 컨테이너 파일 시스템은 컨테이너와 같은 생애주기를 가집니다.

## 6.2 도커 볼륨을 사용하는 컨테이너 실행하기

* 도커 볼륨은 도커에서 스토리지를 다루는 단위입니다.
* 볼륨은 컨테이너와 독립적으로 존재하며 별도의 생애주기를 갖지만, 컨테이너에 연결할 수 있습니다.
* 볼륨을 설정하는 방법은 두 가지가 있습니다.
    * 수동으로 직접 볼륨을 생성해 컨테이너에 연결합니다.
    * Dockerfile 스크립트에서 VOLUME 인스트럭션을 사용하는 방법입니다. 이 인스트럭션을 사용하면 자동으로 볼륨을 생성해줍니다.
* 볼륨은 컨테이너 간 파일 공유보다는 업데이트 간 상태를 보존하기 위한 용도로 사용해야 하며, 이미지에서 정의하는 것보다는 명시적으로 관리하는 편이 더 낫습니다.

## 6.3 파일 시스템 마운트를 사용하는 컨테이너 실행하기

* 볼륨의 장점은 컨테이너와 스토리지의 생애주기를 분리하면서도 도커를 사용하는 방식 그대로 스토리지를 다룰 수 있는 점입니다.
* 호스트의 스토리지를 컨테이너에 좀 더 직접적으로 연결할 수 있는 수단인 바인드 마운트가 있습니다.
* 바인드 마운트는 호스트 컴퓨터 파일 시스템의 디렉터리를 컨테이너 파일 시스템의 디렉터리로 만듭니다.
* 바인드 마운트는 양방향으로 동작합니다.
* 컨테이너에서 만든 파일을 호스트 컴퓨터에서 수정할 수 있고, 반대로 호스트에서 만든 파일도 컨테이너에서 수정할 수 있습니다.
* 파일에 쓰기 작업을 할 필요가 없다면 호스트 컴퓨터의 디렉터리를 읽기 전용으로 컨테이너에 연결할 수 있습니다.

## 6.4 파일 시스템 마운트의 한계점

* 바인드 마운트와 볼륨을 효과적으로 활용하려면 각 요소의 핵심 사용 시나리오와 한계점을 이해해야 합니다.
* 컨테이너의 마운트 대상 디렉터리가 이미 존재하고 이미지 레이어에 이 디렉터리의 파일이 포함돼 있다면 원본 디렉터리가 기존 디렉터리를 완전히 대체합니다. 그래서 이미지에 포함돼 있던 원래 파일은 사용할 수 없습니다.
* 호스트 컴퓨터의 파일 하나를 컨테이너에 이미 존재하는 디렉터리로 마운트하면 디렉터리의 파일이 합쳐져 이미지에서 온 파일과 호스트에서 마운트된 파일이 모두 나타납니다.
* 컨테이너 파일 시스템은 윈도 컨테이너와 리눅스 컨테이너의 동작이 일치하지 않는 몇 안되는 영역 중 하나입니다.
* 분산 파일 시스템을 컨테이너에 바인드 마운트하면 해당 네트워크에 연결된 컴퓨터의 운영체제가 로컬 운영체제와 다른 경우 있어 제대로 동작하지 않는 기능이 있을 수 있습니다.

## 6.5 컨테이너의 파일 시스템은 어떻게 만들어지는가?

* 모든 컨테이너는 도커가 다양한 출처로부터 모아 만든 단일 가상 디스크로 구성된 파일 시스템을 갖습니다. 이 파일 시스템을 유니언 파일 시스템이라고 합니다.
* 컨테이너는 유니언 파일 시스템을 통해 물리적 위치가 서로 다른 파일과 디렉터리에 마치 단일 디스크를 사용하듯 접근할 수 있습니다.
* 다음은 컨테이너의 스토리지를 구성할 때 고려해야 할 일반론입니다.
    * 기록 가능 레이어 : 비용이 비싼 계산이나 네트워크를 통해 저장해야 하는 데이터의 캐싱 등 단기 저장에 적합합니다.
    * 로컬 바인 마운트 : 호스트 컴퓨터와 컨테이너 간 데이터를 공유하기 위해 사용합니다.
    * 분산 바인드 마운트 : 네트워크 스토리지와 컨테이너 간에 데이터를 공유하기 위해 사용합니다. 읽기 전용으로 설정 파일을 전달하거나 공유 캐시로 활용할 수 있으며 읽기 쓰기 가능으로 저장해 동일 네트워크상의 모든 컨테이너나 컴퓨터와 데이터를 공유하는 데 적합합니다.
    * 볼륨 마운트 : 컨테이너와 도커 객체인 볼륨 간에 데이터를 공유하기 위해 사용합니다.
    * 이미지 레이어 : 이미지 레이어는 컨테이너의 초기 파일 시스템을 구성합니다. 레이어는 읽기 전용이며 여러 컨테이너가 공유합니다.

~~~
docker volume create ch06-lab
configSource="$(pwd)/solution"
configTarget='/app/config'
dataTarget='/new-data'
docker container run -d -p 8016:80 --mount type=bind,source=$configSource,target=$configTarget,readonly --volume ch06-lab:$dataTarget diamol/ch06-lab
~~~