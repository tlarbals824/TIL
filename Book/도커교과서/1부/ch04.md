# 4장 애플리케이션 소스 코드에서 도커 이미지까지

* 도커 이미지를 만들기는 어렵지 않습니다. 하지만 애플리케이션을 패키징할 때 인스트럭션을 작성하는것 외에 Dockerfile 스크립트 안에서 명령을 실행하는 것이 있습니다.
* 빌드 중에 실행한 명령과 이로 인해 일어난 파일 시스템 변경은 이미지 레이어에 그대로 저장됩니다.
* 압축 파일을 풀고, 윈도 인스톨러를 실행하는 등 다양한 일을 패키징 과정에 포함시킬 수 있습니다.

## 4.1 Dockerfile이 있는데 빌드 서버가 필요할까?

* 도커를 사용하면 빌드 툴체인을 한 번에 패키징해서 공유할 수 있습니다.
* 개발에 필요한 모든 도구를 배포하는 Dockerfile 스크립트를 작성한 다음 이를 이미지로 만듭니다. 그 다음 애플리케이션 패키징을 위한 Dockerfile 스크립트에서 이 이미지를 사용해 소스 코드를 컴파일함으로써 애플리케이션 패키징하는 것입니다.
* 거의 모든 주요 애플리케이션 프레임워크는 도커 허브를 통해 빌드 도구가 내장된 공식 이미지를 제공합니다.
* 런타임만 제공되는 이미지를 별도로 제공하는 경우도 있습니다.
* 앞선 이미지들을 직접 활용하거나 이들을 포함하는 이미지를 새로 만들어 사용하면 됩니다.
* 이는 프레임워크 개발팀이 유지 보수하는 최신 업데이트를 바로바로 적용할 수 있습니다.

## 4.2 애플리케이션 빌드 실전 예제

* 도커만 설치돼 있다면 어느 애플리케이션이든 실행할 수 있으며 소스 코드와 Dockerfile만 있으면 됩니다. 그 외에는 빌드 도구를 설치할 필요도 없습니다.
* 최종적으로 생성되는 애플리케이션 이미지에 빌드 도구는 포함되지 않습니다.
* 애플리케이션 이미지에는 도커 파일에 정의된 빌드 단계 중 마지막 단계의 콘텐츠만이 포함됩니다.
* 이전 단계의 콘텐츠 중 포함시키고 싶은 것이 있다면 최종 단계에서 명시적으로 해당 콘텐츠를 복사해 와야 합니다.

## 4.5 멀티 스테이지 Dockerfile 스크립트 이해하기

* 멀티 스테이지 Dockerfile 스크립트의 동작 원리와 컨테이너 안에서 애플리케이션을 빌드의 장점은 다음과 같습니다.
    * 표준화 : 어떤 운영체제를 사용하든, 로컬 컴퓨터에 어떤 도구를 설치했는지와 상관없이 모든 빌드 과정은 도커 컨테이너 내부에서 이뤄집니다.
    * 성능 향상 : 멀티 스테이지 빌드의 각 단계는 자신만의 캐시를 따로 갖습니다. 그리고 도커는 빌드 중에 각 인스트럭션에 해당하는 레이어 캐시를 찾습니다. Dockerfile 스크립트를 세심하게 최적화해서 작성한다면 이후로 캐시 재사용을 통해 빌드 단계에서 시간을 절약할 수 있습니다.
    * 멀티 스테이지 Dockerfile 스크립트를 통해 빌드 과정을 세밀하게 조정하며 최종 산출물인 이미지를 가능한 작게 유지할 수 있습니다.

## 4.6 연습 문제

~~~
FROM diamol/golang AS builder

COPY main.go .
RUN go build -o /server
RUN chmod +x /server

FROM diamol/base

CMD ["/web/server"]
ENV USER=sixeyed
EXPOSE 80

WORKDIR web
COPY --from=builder /server .
COPY index.html .
~~~
