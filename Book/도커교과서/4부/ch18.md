# 18장 컨테이너의 애플리케이션 설정 관리

* 애플리케이션은 환경 변수 또는 파일의 형태로 외부에서 설정을 주입받아야 합니다.

## 18.1 다단 애플리케이션 설정

* 설정 모델은 설정에 담긴 데이터의 구조를 반영해야 합니다.
* 설정 데이터의 종류는 주로 3가지가 있습니다.
  1. 버전에 따라 달라지는 설정 : 모든 환경에서 동일하지만 버전별로 달라지는 설정
  2. 환경에 따라 달라지는 설정 : 환경별로 달라지는 설정
  3. 기능 설정 : 버전별로 애플리케이션의 동작을 달리하기 위한 설정
* 설정 적용에 있어 미리 정의된 경로에서 오버라이드 설정 파일을 읽어 들이도록 해 두면, 어떤 경로로든 컨테이너 파일 시스템에 해당 설정을 적용할 수 있습니다.

## 18.2 환경별 설정 패키징하기

* 여러 가지 애플리케이션 프레임워크에서 환경별 설정 파일을 모두 배포에 포함시킬 수 있는 기능을 제공합니다. ex) application.yml, application-dev.yml
* 설정 파일과 소스 코드를 별도의 시스템으로 관리한다면 CI/CD 파이프라인에서 설정 파일을 소스 코드로 가져와 이미지를 빌드하는 방법으로 설정을 배포할 수 있습니다.
* 설정 파일과 소스 코드를 별도의 시스템으로 분리하면 이미지에 포함시킬 수 없는 민감한 정보 때문에 외부에서 컨테이너에 주입해야 하는 정보가 남는 단점이 있습니다.
* 레지스트리는 항상 외부에 노출될 위험이 있다고 가정하고 보안에 만전을 가해야 합니다.

## 18.3 런타임에서 설정 읽어 들이기

* 설정 API를 통해 현재 설정 내용을 출력할때 비밀값과 같은 민감 정보를 API를 통해 노출하지 않기 위해서는 다음을 만족시켜야합니다.
  * 전체 설정을 공개하지 않습니다. 민감하지 않은 정보만 선택하되 민감한 정보는 절대 포함시키지 않습니다.
  * 허가받은 사용자만이 접근할 수 있도록 엔드포인트에 보안을 설정합니다.
  * 설정 API의 사용 여부를 설정할 수 있어야 합니다.

## 18.4 레거시 애플리케이션에 설정 전략 적용하기

* 환경 변수나 설정 파일이 병합을 통한 설정 구성은 일반적으로 지원하지 않습니다. 하지만 Dockerfile 스크립트를 통해 여러 설정 파일을 병합할 수 있습니다.
* 컨테이너에 주입된 설정 파일을 애플리케이션 설정 전략에 맞춰 변환하는 유틸리티 또는 스크립트를 이미지에 포함시키는 방법은 다음과 같습니다.
  1. 컨테이너에 지정된 오버라이드 설정 파일을 읽어 들이기
  2. 환경 변수에서 오버라이드 설정 읽어 들이기
  3. 오버라이드 설정 파일과 환경 변수 설정을 병합하기. 이때, 환경 변수 값이 우선한다.
  4. 병합된 오버라이드 설정을 컨테이너 내 대상 설정 파일에 추가합니다.
* 도커 이미지를 확장해 기존 애플리케이션에 현대적 설정 모델을 도입할 수 있지만 이로인해 컨테이너 시작과 애플리케이션 실행 사이에 시간 간격이 생기며,
컨테이너가 실패할 확률이 높아집니다. 이를 헬스 체크를 통해 대처할 수 있습니다.
* 애플리케이션들의 구성 요소가 조금씩 달라 혼선이 발생할 수 있으며 이를 문서화를 통해 해결할 수 있습니다.
* 애플리케이션 매니패스트가 앞선 문서 역할을 가장 잘 수행할 수 있습니다.

## 18.5 유연한 설정 모델의 이점

* 계층별 설정 모델은 애플리케이션의 동작은 각 환경마다 조금씩 다르게 하면서도 단일 이미지 원칙을 유지할 수 있게 해줍니다.
* 모든 컨테이너 런타임은 컨피그 객체나 비밀값을 컨테이너에 주입하거나 환경 변수를 설정해 주는 기능을 갖추고 있습니다.