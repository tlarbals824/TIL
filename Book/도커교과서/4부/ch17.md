# 17장 도커 이미지 최적화하기 : 보안, 용량, 속도

## 17.1 도커 이미지를 최적화하는 방법

* 도커 이미지는 이미지끼리 레이어를 최대한 공유하기에 최적화하기에 좋습니다.
* 도커는 데이터를 보수적으로 다룹니다. 내려받은 이미지는 명시적으로 삭제하지 않는 한 자동으로 삭제되지 않습니다.
* 도커에서 이미지를 최적화하는 방법으로는 꼭 필요한 파일만 이미지에 포함시키는 것입니다.
  * Dockerfile 스크립트의 인스트럭션 하나마다 이미지 레이어가 하나씩 생기며 이 레이어들이 모여 이미지가 전체 이미지가 됩니다. 따라서 한 번 이미지에 복사된 파일은 뺄 수 없습니다.
  * .dockerignore 파일을 사용해 이미지에 포함시키지 않을 파일을 지정할 수 있습니다.

## 17.2 좋은 기반 이미지를 고르는 법

* 기반 이미지의 크기는 디스크 용량이나 네트워크 전송 시간뿐만 아닌 애플리케이션 보안과도 관계가 깊습니다.
* 기반 이미지를 통해 공격자가 해당 컨테이너에 접속해서 애플리케이션을 공격하거나 컨테이너를 제어할 수 있습니다.
* 공격자의 공격은 컨테이너의 네트워크 접근을 차단하더라도 유효할 수 있습니다.
* 기반 이미지가 애플리케이션 실행에 필요한 모든 것을 갖춰야 하지만, 빌드에 필요한 도구를 포함시켜서는 안됩니다.
* 앞선 문제는 골든 이미지를 통해 해결할 수 있습니다.
* 골든 이미지를 관리하는 과정에서 앤코어 같은 서드파티 도구를 사용해 이미지 빌드 중 보안 검사를 할 수도 있습니다.

## 17.3 이미지 레이어 수와 이미지 크기는 최소한으로

* 최소한의 크기와 보안성을 갖춘 기반 이미지는 애플리케이션 이미지 최적화의 전제 조건입니다. 그 다음으로는 꼭 필요한 것만 포함하는 이미지를 만드는 것입니다.
* 꼭 필요한 것만 포함시키기 어려울 수 있습니다.즉, 소프트웨어를 설치하면 패키지 목록을 캐싱하거나 추천 패키지 등을 함께 설치하기에 대부분의 경우
불필요한 요소나 설치 후 잔재가 발생합니다.
* 여러개의 RUN 인스트럭션을 하나로 합치면 이미지 레이어 수를 줄여 여분의 레이어를 남길 수 있고, 레이어 수가 적음에 따라 컨테이너 파일 시스템의 내용을 추적하기 쉬워집니다.

## 17.4 멀티 스테이지 빌드를 한 단계 업그레이드하기

* 멀티 스테이지 빌드를 통해 이미지를 최적화할 수 있습니다.
* 멀티 스테이지 Dockerfile 스크립트는 원하는 지점까지만 이미지를 빌드할 수 있기에 파일 시스템의 주간 상태를 확인하고 싶을 때 이미지 레이어 식별자를 찾지 않아도
된다는 장점이 있습니다.
* 캐시를 잘 활용하면 소스 코드를 수정할 때마다 CI/CD 파이프라인에서 시간을 낭비하지 않고도 이미지를 빌드하고 푸시할 수 있습니다.
* RUN 인스트럭션을 사용해 내려받거나 설치한 소프트웨어처럼 불필요한 요소까지 캐싱하지 않도록 주의해야 합니다.

## 17.5 최적화가 중요한 이유

* 기반 이미지 잘 고르며 자신만의 골든 이미지를 갖출 수 있으면 이상적입니다.
* 아주 간단한 애플리케이션이 아니라면 멀티 스테이지 빌드를 적용합니다.
* 불필요한 패키지나 파일을 포함시키지 말고, 레이어 크기를 최소한으로 유지합니다.
* Dockerfile 스크립트의 인스트럭션은 자주 수정하는 순서대로 뒤에 오도록 배치해 캐시를 최대한 활용해야 합니다.