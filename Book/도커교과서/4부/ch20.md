# 20장 리버스 프록시를 이용해 컨테이너 HTTP 트래픽 제어하기

* 도커 엔진은 외부에서 들어온 트래픽을 컨테이너까지 이어주는 라우팅을 지원해줍니다. 하지만 컨테이너가 주시할 수 있는 네트워크 포트는 하나뿐입니다.
* 리버스 프록시는 컨테이너 환경에 적합한 애플리케이션 설계에서 매우 중요한 역할을 합니다.

## 20.1 리버스 프록시란?

* 네트워크의 프록시는 네트워크상의 다른 구성 요소를 대신해 네트워크 트래픽을 처리하는 네트워크 구성 요소를 말합니다.
* 리버스 프록시는 여러 웹 애플리케이션으로 통하는 관문 역할을 합니다.
* 모든 트래픽은 리버스 프록시를 거치며 해당 트래픽이 어떤 애플리케이션에서 출발한 것인지 판단하며 애플리케이션의 응답 내용을 캐시해 두엇다가 적절하게 가공해 클라이언트에게 전달하기도 합니다.
* 리버스 프록시는 포트를 외부로 공개하는 유일한 컨테이너 입니다. 이를 통해 컨테이너를 외부로 노출할 필요가 없어졌습니다.
* 리버스 프록시는 HTTP로 제공되는 컨텐츠라면 무엇이든 제공할 수 있습니다.
* 리버스 프록시를 통해 모든 애플리케이션 트래픽을 관리하며 설정의 중심 역할을 할 수 있습니다. 또한 인프라 수준의 사항을 애플리케이션 컨테이너와 분리할 수 있다는것도 장점입니다.

## 20.2 리버스 프록시의 라우팅과 SSL 적용하기

* 엔지엑스를 시작할 때, 애플리케이션 컨테이너를 실행하고 엔진엑스를 시작해야 합니다. 이는 엔진엑스가 설정 파일을 모두 읽은 다음 애플리케이션 컨테이너에 접근이 가능한지 확인하기 때문입니다.
* 엔진엑스에서 모든 업스트림에 연결이 가능하다면 호스명과 IP 주소를 연결한 내부 라우팅 리스트를 만듭니다. 해당 부분이 프록시가 맡아 처리해 주는 첫 번째 인프라 관련 사항입니다.
* 업스트림이 여러개이면 로드 밸런싱도 처리해줍니다.
* 설정에 지정된 인증서와 키 파일을 컨테이너 파일 시스템에서 읽어 들입니다. 인증서와 키 파일 쌍은 하나의 도메인에 한해서만 유효하므로 애플리케이션 하나마다 인증서와 키 파일 세트가 필요합니다.
* 인증서와 키 파일은 민감한 정보이기에 운영 환경에서는 비밀값 형태로 클러스터에 저장됩니다.

## 20.3 프록시를 이용한 성능 및 신뢰성 개선

* 엔진엑스는 고성능 HTTP 서버입니다. 이는 정적 HTML 콘텐츠나 단일 페이지 애플리케이션을 제공하는데 활용할 수 있으며, 컨테이너 하나만으로도 초당 수천 건의 요청을 처리할 수 있습니다.
* 엔진엑스의 캐싱 프록시를 이용하면 애플리케이션을 개선하는 데 활용할 수 있습니다.
* 캐싱 프록시의 장점은 다음과 같습니다.
  1. 요청을 처리하는 시간을 줄일 수 있습니다.
  2. 애플리케이션을 오가는 트래픽을 줄일 수 있으므로 기존보다 더 많은 요청을 처리할 수 있습니다.
* 캐시 설정인 proxy_cache_use_stale을 사용하면 캐시가 만료되었을 때도 캐시를 사용할 수 있습니다. 이를통해 애플리케이션에 장애가 발생하더라도 서비스를 제공할 수 있습니다.

## 20.4 클라우드 네이티브 리버스 프록시

* 클라우드 네이티브 리버스 프록시 도구인 트래픽(Traefik)은 도커 API의 애플리케이션 질의를 통해 다른 컨테이너에 대한 정보를 얻는 방식으로 동작합니다.
* 트래픽을 사용해 프록시를 적용하려면 애플리케이션별로 설정 파일을 따로 둘 필요 없이 컨테이너에 레이블을 추가하면 됩니다. 그러면 이러한 정보를 통해 스스로 라우팅 맵을 구성합니다.
* 트래픽 등과 같은 컨테이너용 프록시의 가장 큰 장점은 동적 설정을 구성할 수 있다는 점에 있습니다. 이러한 장점을 통해 앞선 엔진엑스의 실행 순서와 같이 애플리케이션을 먼저 실행하지 않아도 됩니다.
* 트래픽의 경우 캐시를 지원하지 않습니다. 따라서 캐싱 프록시를 사용하기 위해서는 엔진엑스를 사용해야합니다.
* 트래픽은 SSL 지원이 잘되어 있어 Let's Encrypt 서비스를 통해 자동으로 인증서가 갱신됩니다.
* 트래픽은 스티키 세션(sticky session)을 통해 클라이언트에 컨테이너에 식별할 수 있는 쿠키가 부여되므로 해당 사용자의 요청을 계속 같은 컨테이너로 라우팅할 수 있습니다.

## 20.5 리버스 프록시를 활용한 패턴의 이해

* 리버스 프록시가 있어야 적용할 수 있는 세 가지 주요 패턴은 다음과 같습니다.
  1. 클라이언트 요청에 포함된 호스트명을 통해 HTTP, HTTPS로 제공되는 애플리케이션에서 적확한 콘텐츠를 제공하는 패턴
  2. 한 애플리케이션이 여러 개의 컨테이너에 걸쳐 실행되는 마이크로서비스 아키텍처에서 주로 활용되며 리버스 프록시는 HTTP 요청의 경로를 이용해 마이크로서비스의 요소 중 일부만 선택적으로 노출합니다.(API Gateway?)
  3. 구식 모놀리스 설계를 가진 애플리케이션을 컨테이너로 이주할 때 유용한 패턴이며, 이는 먼저 리버스 프록시를 두어 모놀리식 설계를 가진 애플리케이션의 프론트엔드 역할을 맡깁니다. 그 후 추가되는 기능을 컨테이너로 분리합니다.
* 앞선 패턴들을 여러가지 함께 사용해 애플리케이션을 설계할 수 있습니다.