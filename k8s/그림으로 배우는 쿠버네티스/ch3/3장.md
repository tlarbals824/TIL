# 3장

## Pod

```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    run: po-nginx
  name: po-nginx
spec:
  containers:
  - image: docker.io/library/nginx
    name: nginx 
```

## Deployment

```yaml
apiVersion: apps/v1       # Deployment는 apps/v1 API 그룹 사용
kind: Deployment          # 리소스 종류
metadata:
  labels:
    app: deploy-nginx     # Deployment 자체에 붙는 라벨 (관리/조회용)
  name: deploy-nginx      # Deployment 이름
spec:                     # Deployment 스펙
  replicas: 3             # 유지할 Pod 개수
  selector:
    matchLabels:
      app: po-nginx       # 이 라벨을 가진 Pod들을 관리 대상으로 선택
  template:               # 생성할 Pod의 템플릿
    metadata:
      labels:
        app: po-nginx     # Pod에 붙는 라벨 (selector와 일치해야 함)
    spec:                 # Pod 스펙
      containers:
        - image: docker.io/library/nginx
          name: nginx
```

**핵심 관계**

```
Deployment
    │
    ├─ selector.matchLabels: app=po-nginx  ──┐
    │                                        │ 반드시 일치
    └─ template                              │
         └─ metadata.labels: app=po-nginx ──┘
               │
               └─ spec.containers (실제 컨테이너 정의)
```

## ReplicaSet

지정한 수의 Pod 복제본을 항상 유지하는 컨트롤러

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  labels:
    app: rs-nginx
  name: rs-nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: po-nginx
  template:
    metadata:
      labels:
        app: po-nginx
    spec:
      containers:
        - image: docker.io/library/nginx
          name: nginx
```

**Deployment vs ReplicaSet**

|               | ReplicaSet | Deployment |
| ------------- | ---------- | ---------- |
| Pod 복제/유지 | ✅          | ✅          |
| 롤링 업데이트 | ❌          | ✅          |
| 롤백          | ❌          | ✅          |
| 버전 히스토리 | ❌          | ✅          |

**실제 관계**

```
Deployment
    │
    └─ ReplicaSet (자동 생성)
           │
           ├─ Pod 1
           ├─ Pod 2
           └─ Pod 3
```

즉, Deployment가 ReplicaSet을 만들고, ReplicaSet이 Pod을 관리합니다.

```
> k get deploy
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
deploy-nginx   3/3     3            3           36s
> k get rs
NAME                      DESIRED   CURRENT   READY   AGE
deploy-nginx-79d75f4dbf   3         3         3       38s
rs-nginx                  3         3         3       2m41s
> k get po
NAME                            READY   STATUS    RESTARTS   AGE
deploy-nginx-79d75f4dbf-5x9dd   1/1     Running   0          40s
deploy-nginx-79d75f4dbf-bvxq4   1/1     Running   0          40s
deploy-nginx-79d75f4dbf-knqhv   1/1     Running   0          40s
rs-nginx-bjpzm                  1/1     Running   0          2m43s
rs-nginx-rvdpn                  1/1     Running   0          2m43s
rs-nginx-vts2l                  1/1     Running   0          2m43s
```

## Job

한 번 실행하고 완료되는 작업을 위한 컨트롤러

```
Job
 └─ Pod (작업 완료되면 종료)
      └─ Container (실제 작업 실행)
```

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: job-example
spec:
  completions: 1          # 성공해야 할 횟수 (기본값: 1)
  parallelism: 1          # 동시 실행 Pod 수 (기본값: 1)
  backoffLimit: 4         # 실패 시 재시도 횟수 (기본값: 6)
  ttlSecondsAfterFinished: 60  # 완료 후 60초 뒤 자동 삭제
  template:
    spec:
      restartPolicy: Never  # Never 또는 OnFailure만 가능
      containers:
        - name: worker
          image: docker.io/library/busybox
          command: ["echo", "Hello, Job!"]
```

Job VS Deployment

```
Deployment ─→ ReplicaSet ─→ Pod (계속 유지)
Job ─→ Pod (완료되면 끝)
```

### Job 병렬 처리

* completions: 총 몇 번 성공해야 Job 완료인가
* parallelism: 동시에 몇 개 Pod을 실행할 것인가

1. 기본값
```
spec:
  completions: 1
  parallelism: 1
---
Pod 1 ████████ 완료
```

2. 순차 실행

```
spec:
  completions: 5
  parallelism: 1
---
Pod 1 ████ 완료
Pod 2      ████ 완료
Pod 3           ████ 완료
Pod 4                ████ 완료
Pod 5                     ████ 완료
```

3. 병렬 실행

```
spec:
  completions: 5
  parallelism: 2
---
Pod 1 ████ 완료
Pod 2 ████ 완료
Pod 3      ████ 완료
Pod 4      ████ 완료
Pod 5           ████ 완료
```

4. Work Queue 패턴

```
spec:
  parallelism: 3
  # completions 생략
---
Pod 1 ████████████ (큐 비면 종료)
Pod 2 ████████ (큐 비면 종료)
Pod 3 ██████████ (큐 비면 종료)
```

실패시 동작

```
spec:
  completions: 3
  parallelism: 2
  backoffLimit: 4
---
Pod 1 ████ 성공 (completions: 1/3)
Pod 2 ██ 실패
Pod 3      ████ 성공 (completions: 2/3)
Pod 4      ██ 실패 (재시도 1)
Pod 5           ████ 성공 (completions: 3/3) → Job 완료
```

## CronJob

주기적으로 Job을 생성하는 컨트롤러

```
CronJob
 └─ Job (스케줄마다 생성)
      └─ Pod
           └─ Container
```

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-cronjob
spec:
  schedule: "0 2 * * *"           # 매일 새벽 2시
  concurrencyPolicy: Forbid       # 동시 실행 정책
  successfulJobsHistoryLimit: 3   # 성공 Job 보관 개수
  failedJobsHistoryLimit: 1       # 실패 Job 보관 개수
  startingDeadlineSeconds: 60     # 스케줄 놓치면 60초 내 시작
  suspend: false                  # true면 일시 중지
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: docker.io/library/busybox
              command: ["echo", "Backup!"]
```

**스케줄 문법 (Cron 표현식)**
```
┌───────────── 분 (0-59)
│ ┌───────────── 시 (0-23)
│ │ ┌───────────── 일 (1-31)
│ │ │ ┌───────────── 월 (1-12)
│ │ │ │ ┌───────────── 요일 (0-6, 0=일요일)
│ │ │ │ │
* * * * *
```

**주요 설정**

| 설정                         | 설명                         |
| ---------------------------- | ---------------------------- |
| `schedule`                   | Cron 표현식 (필수)           |
| `concurrencyPolicy`          | 동시 실행 정책               |
| `successfulJobsHistoryLimit` | 성공 Job 보관 개수 (기본: 3) |
| `failedJobsHistoryLimit`     | 실패 Job 보관 개수 (기본: 1) |
| `startingDeadlineSeconds`    | 스케줄 놓쳤을 때 허용 시간   |
| `suspend`                    | 일시 중지 여부               |

**concurrencyPolicy 옵션**

| 값        | 동작                             |
| --------- | -------------------------------- |
| `Allow`   | 동시 실행 허용 (기본값)          |
| `Forbid`  | 이전 Job 실행 중이면 새 Job 스킵 |
| `Replace` | 이전 Job 취소하고 새 Job 실행    |
```
Allow:   Job1 ████████
         Job2     ████████  (겹쳐도 실행)

Forbid:  Job1 ████████
         Job2          ████████  (끝나야 실행)

Replace: Job1 ████ (취소)
         Job2     ████████  (대체)
```

## DaemonSet

모든 노드에 Pod을 하나씩 배포하는 컨트롤러

```
DaemonSet
 ├─ Node 1 → Pod
 ├─ Node 2 → Pod
 └─ Node 3 → Pod
```

```
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: log-collector
spec:
  selector:
    matchLabels:
      app: log-collector
  template:
    metadata:
      labels:
        app: log-collector
    spec:
      containers:
        - name: fluentd
          image: docker.io/fluent/fluentd
          volumeMounts:
            - name: varlog
              mountPath: /var/log
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
```

Deployment vs DaemonSet

|           | Deployment      | DaemonSet         |
| --------- | --------------- | ----------------- |
| Pod 수    | replicas로 지정 | 노드당 1개 (자동) |
| 배포 위치 | 스케줄러가 결정 | 모든 노드         |
| 용도      | 일반 앱         | 노드 레벨 작업    |

## StatefulSet

상태가 있는 애플리케이션을 위한 컨트롤러

```
StatefulSet
 ├─ pod-0 → PVC-0 (고정)
 ├─ pod-1 → PVC-1 (고정)
 └─ pod-2 → PVC-2 (고정)
```

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  serviceName: mysql-headless   # Headless Service 필수
  replicas: 3
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
        - name: mysql
          image: docker.io/library/mysql:8.0
          ports:
            - containerPort: 3306
          volumeMounts:
            - name: data
              mountPath: /var/lib/mysql
  volumeClaimTemplates:         # Pod별 PVC 자동 생성
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi
```

### Deployment vs StatefulSet

| 특징 | Deployment | StatefulSet |
| --- | --- | --- |
| Pod 이름 | 랜덤 (app-7x2nq) | 순차적 (app-0, app-1, app-2) |
| 생성/삭제 순서 | 무작위 | 순차적 (0→1→2 / 2→1→0) |
| 네트워크 ID | 변경됨 | 고정 (DNS) |
| 스토리지 | 공유 또는 없음 | Pod별 고정 PVC |

