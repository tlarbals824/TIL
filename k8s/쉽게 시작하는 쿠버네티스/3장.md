# 기초

## pod

* 쿠버네티스는 컨테이너를 관리하기 위한 애플리케이션임
* pod은 컨테이너의 집합
* 하나의 일을 하기 위한 컨테이너 집합
* 대부분 단일 컨테이너가 하나의 팟으로 구성된다.
* kubectl run nginx --image=nginx로 팟을 배포할 수 있음

```
root@cp-k8s:~# kubectl run nginx --image=nginx
pod/nginx created
root@cp-k8s:~# kubectl get pod
NAME    READY   STATUS              RESTARTS   AGE
nginx   0/1     ContainerCreating   0          10s
root@cp-k8s:~# kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          17s
root@cp-k8s:~# kubectl get pod -o wide
NAME    READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES
nginx   1/1     Running   0          32s   172.16.221.129   w1-k8s   <none>           <none>
root@cp-k8s:~# curl 172.16.221.129
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```

## 배포한 파드가 외부에서 접근 안되는 경우

* 쿠버네티스 클러스터에서 외부와 통신하기 위해서는 다음과 같은 방법이 있음
1. 외부와의 통신을 열어버림. 보안 x
2. 서비스 영역을 정의하고 서비스와 팟을 연결해 외부와 통신할 수 있도록 함. NodePort를 활용함.

### NodePort를 통한 외부 통신 설정

1. 생성된 pod 이름과 kubectl expose를 통해 외부로 노출할 수 있음
`kubectl expose pod {podName} --type=NodePort --port={exposePodPortNumber}`
2. 앞선 명령어를 실행하면 `service/{podName} exposed`를 확인할 수 있음. 이는 서비스가 생성되었음을 의미하고, kubectl get service를 통해 생성된 서비스를 확인할 수 있음
3. 생성된 서비를 확인해보면 팟의 포트와 외부에 노출된 포트번호를 확인할 수 있음. `{exposePodPortNumber}/{externalPortNumber}`
4. 접속은 서비스 생성 대상인 팟이 생성된 워커에 생성된 포트를 통해 접속할 수 있음


```
root@cp-k8s:~# kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          5m41s
root@cp-k8s:~# kubectl expose pod nginx --type=NodePort --port=80
service/nginx exposed
root@cp-k8s:~# kubectl get service
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1      <none>        443/TCP        24m
nginx        NodePort    10.104.186.3   <none>        80:31953/TCP   14s
root@cp-k8s:~# kubectl get nodes -o wide
NAME     STATUS   ROLES           AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION       CONTAINER-RUNTIME
cp-k8s   Ready    control-plane   24m   v1.30.0   192.168.1.10    <none>        Ubuntu 22.04.5 LTS   5.15.0-142-generic   containerd://1.6.31
w1-k8s   Ready    <none>          22m   v1.30.0   192.168.1.101   <none>        Ubuntu 22.04.5 LTS   5.15.0-142-generic   containerd://1.6.31
w2-k8s   Ready    <none>          22m   v1.30.0   192.168.1.102   <none>        Ubuntu 22.04.5 LTS   5.15.0-142-generic   containerd://1.6.31
w3-k8s   Ready    <none>          21m   v1.30.0   192.168.1.103   <none>        Ubuntu 22.04.5 LTS   5.15.0-142-generic   containerd://1.6.31
root@cp-k8s:~# kubectl get pod -o wide
NAME    READY   STATUS    RESTARTS   AGE    IP               NODE     NOMINATED NODE   READINESS GATES
nginx   1/1     Running   0          7m2s   172.16.221.129   w1-k8s   <none>           <none>
```

# 팟을 여러개 사용하려면?

* 팟을 배포할 때, 하나만 배포되었음. 모든 노드에 배포하려면 deployment를 활용하면 됨
* deployment는 pod을 여러개 묶어둔 단위라고 생각하면 됨
* 하지만, 최신 버전에서는 kubectl run이 아닌 kubectl (create|apply)를 활용해 생성해야함
* kubectl run을 테스트용에 가까움

## deployment 실습

```
root@cp-k8s:~# kubectl create deployment deploy-nginx --image=nginx
deployment.apps/deploy-nginx created
root@cp-k8s:~# kubectl get deployment
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
deploy-nginx   0/1     1            0           6s
root@cp-k8s:~# kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
deploy-nginx-74d7d6d848-b8hvr   1/1     Running   0          14s
nginx                           1/1     Running   0          16m
root@cp-k8s:~# kubectl get pod
NAME                            READY   STATUS    RESTARTS   AGE
deploy-nginx-74d7d6d848-b8hvr   1/1     Running   0          16s
nginx                           1/1     Running   0          16m
root@cp-k8s:~# kubectl get pod -o wide
NAME                            READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES
deploy-nginx-74d7d6d848-b8hvr   1/1     Running   0          37s   172.16.103.129   w2-k8s   <none>           <none>
nginx                           1/1     Running   0          16m   172.16.221.129   w1-k8s   <none>           <none>
root@cp-k8s:~# curl 172.16.103.129
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
root@cp-k8s:~# 
```

### pod 수 조절

* ReplicaSet을 활용해서 팟을 여러개를 생성하도록 할 수 있음

```
root@cp-k8s:~# kubectl scale deployment deploy-nginx --replicas=3
deployment.apps/deploy-nginx scaled
root@cp-k8s:~# kubectl get deployment
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
deploy-nginx   2/3     3            2           2m25s
root@cp-k8s:~# kubectl get pod
NAME                            READY   STATUS              RESTARTS   AGE
deploy-nginx-74d7d6d848-82xnr   1/1     Running             0          11s
deploy-nginx-74d7d6d848-b8hvr   1/1     Running             0          2m30s
deploy-nginx-74d7d6d848-ws7jp   0/1     ContainerCreating   0          11s
nginx                           1/1     Running             0          18m
root@cp-k8s:~# kubectl get pod -o wide
NAME                            READY   STATUS    RESTARTS   AGE     IP               NODE     NOMINATED NODE   READINESS GATES
deploy-nginx-74d7d6d848-82xnr   1/1     Running   0          21s     172.16.221.130   w1-k8s   <none>           <none>
deploy-nginx-74d7d6d848-b8hvr   1/1     Running   0          2m40s   172.16.103.129   w2-k8s   <none>           <none>
deploy-nginx-74d7d6d848-ws7jp   1/1     Running   0          21s     172.16.132.1     w3-k8s   <none>           <none>
nginx                           1/1     Running   0          18m     172.16.221.129   w1-k8s   <none>           <none>
root@cp-k8s:~# 
```

## 생성한 deployment 외부로 노출하기

* 하지만 가장 좋은 방법이 아님. LoadBalancer를 활용하면 좋음

```
root@cp-k8s:~# kubectl expose deployment deploy-nginx --type=NodePort --port=80
service/deploy-nginx exposed
root@cp-k8s:~# kubectl get service
NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
deploy-nginx   NodePort    10.96.241.169   <none>        80:31075/TCP   8s
kubernetes     ClusterIP   10.96.0.1       <none>        443/TCP        38m
nginx          NodePort    10.104.186.3    <none>        80:31953/TCP   14m
```

# 노드포트보다 로드밸러서가 좋은 점

* 로드밸런서는 대표 ip를 통해서 외부로 노출할 수 있음
* NodePort는 노드의 포트를 인지하고 있음
* 로드밸런서는 트래픽 최적화도 가능함

# 생성된 자원 제거하기

* `kubectl delete {type} {resoucrName}`을 통해 제거할 수 있음

